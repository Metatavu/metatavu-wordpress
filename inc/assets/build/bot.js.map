{"version":3,"sources":["../js/bot.js"],"names":["ajaxurl","metamindmwp","useOldConversation","window","metamind","Metamind","sessionId","getBotStatus","apiUrl","$","document","on","e","sendMessage","text","openChat","closeChat","addClass","getSessionId","then","updateBotStatus","get","outerHTML","hide","show","hasClass","scrollChatBody","disabled","attr","message","val","trim","undefined","empty","append","replaceLineBreaks","replace","scrollTop","scrollHeight","open","messages","botStatus","Date","now","localStorage","removeItem","setItem","JSON","stringify","parse","getItem","appendChatContentFromLocalStorage","html","hourPassed","lastUpdate","checkChatOpenStatus","console","log","data","removeAttr","i","quickResponses","length","parsedResponse","response","type","find","dateAfterParam","dateAfter","dateAfterParts","split","moment","add","toDate","subtract","flatpickrInstance","_flatpickr","set","hint","is","ready","flatpickr","event","keyCode"],"mappings":"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","file":"bot.js","sourcesContent":["(() => {\n  'use strict';\n\n  var ajaxurl = metamindmwp.ajaxurl;\n\n  if (useOldConversation()) {\n    window.metamind = new window.Metamind({sessionId: getBotStatus().sessionId, apiUrl: 'http://dev-metamind.com:8080/v1', 'story': 'metatavu-bot' });\n  } else {\n    window.metamind = new window.Metamind({apiUrl: 'http://dev-metamind.com:8080/v1', 'story': 'metatavu-bot' });\n  }\n  \n  $(document).on('click', '.quick-message-btn', function(e) {\n    sendMessage($(this).text());\n  });\n\n  $(document).on('click', '.send-msg-btn', function(e) {\n    sendMessage();\n  });\n  \n  $(document).on('click', '.chatbot', function () {\n    openChat();\n  });\n\n  $(document).on('click', '.minimize-chat', function () {\n    closeChat();\n  });\n\n  $(document).on('click', '.close-bubble', function () {\n    $('.bubble').addClass('d-none');\n  });\n  \n  function closeChat () {\n    window.metamind.getSessionId().then((sessionId) => {\n      updateBotStatus(sessionId, false, $('.chat-container').get(0).outerHTML);\n      $('.chat-window').hide();\n      $('.chatbot-container').show();\n    });\n  }\n  \n  function openChat () {\n    window.metamind.getSessionId().then((sessionId) => {\n      updateBotStatus(sessionId, true, $('.chat-container').get(0).outerHTML);\n      if (!$('.bubble').hasClass('d-none')) {\n        $('.bubble').addClass('d-none');\n      }\n\n      $('.chat-window').show();\n      $('.chatbot-container').hide();\n      scrollChatBody();\n    });\n  }\n  \n  function sendMessage(text) {\n    window.metamind.getSessionId().then((sessionId) => {\n      const disabled = $('.send-msg-btn').attr('disabled');\n      const message = text || $('.message-input').val() || $('.user-date-input').val();\n\n      if (!message.trim()) {\n        return;\n      }\n\n      if (typeof disabled !== typeof undefined && disabled !== false) {\n        return;\n      }\n\n      $('.bot-typing').show();\n      $('.message-input').val('');\n      $('.send-msg-btn').attr('disabled', 'disabled');\n      $('#botHintText').text('');\n      $('.quick-responses').empty();\n      $('.chat-body').append(\n        `<div class=\"message-container\">\n          <img src=\"/wp-content/themes/metatavu-wordpress/inc/assets/gfx/user-icon.png\" class=\"user-avatar\" />\n          <div class=\"message message-received\">\n            <p class=\"message-content\">\n              ${message}\n            </p>\n          </div>\n        </div>`  \n      );\n      window.metamind.sendMessage(message, 'send_message');\n      scrollChatBody();\n      updateBotStatus(sessionId, true, $('.chat-container').get(0).outerHTML);\n  });\n  }\n  \n  function replaceLineBreaks(text) {\n    return (text||'').replace(/\\n/g, '<br/>');\n  }\n\n  function scrollChatBody () {\n    $('.chat-body').scrollTop($('.chat-body')[0].scrollHeight);\n  }\n  \n  function updateBotStatus (sessionId, open, messages) {\n    const botStatus = {\n      \"sessionId\": sessionId,\n      \"open\": open,\n      \"messages\": messages,\n      \"lastUpdate\": Date.now()\n    };\n    localStorage.removeItem(\"botStatus\");\n    localStorage.setItem(\"botStatus\", JSON.stringify(botStatus));\n  }\n  \n  function getBotStatus () {\n    const botStatus = JSON.parse(localStorage.getItem(\"botStatus\"));\n    return botStatus;\n  }\n  \n  function appendChatContentFromLocalStorage () {\n    const botStatus = getBotStatus();\n    \n    $('.chat-window').html(botStatus.messages);\n  }\n  \n  function useOldConversation () {\n    const botStatus = getBotStatus();\n    let hourPassed = false;\n    \n    if (botStatus) {\n      hourPassed = (botStatus.lastUpdate + 3600000) < Date.now();\n    }\n    \n    if (hourPassed || !botStatus) {\n      return false;\n    } else {\n      return true;\n    }\n  }\n  \n  function checkChatOpenStatus() {\n    const botStatus = getBotStatus();\n    if (botStatus.open) {\n      console.log(\"open\");\n      $('.chat-window').show();\n      $('.chatbot-container').hide();\n      scrollChatBody();\n    }\n  }\n  \n  window.metamind.on('response', function(data) {\n    window.metamind.getSessionId().then((sessionId) => {\n      $('.bot-typing').hide();\n      $('.send-msg-btn').removeAttr('disabled');\n      $('.message-input').val('');\n\n      for (var i = 0; i < data.quickResponses.length; i++) {\n        $('.quick-responses').append(`<button class=\"btn btn-info btn-sm quick-message-btn\">${data.quickResponses[i]}</button>`);\n      }\n\n      const parsedResponse = $('<pre>').html(data.response);\n      const type = parsedResponse.find('input[name=\"metamind-hint-type\"]').val() || 'text';\n\n      if (type === 'date') {\n        const dateAfterParam = parsedResponse.find('input[name=\"metamind-hint-date-after\"]').val();\n        let dateAfter = null;\n        if (dateAfterParam) {\n          const dateAfterParts = dateAfterParam.split(' ');\n          if (dateAfterParts.length === 3) {       \n            if (dateAfterParts[0] === 'add') {\n              dateAfter = moment().add(dateAfterParts[1], dateAfterParts[2]).toDate();\n            } else if (dateAfterParam[0] === 'subtract') {\n              dateAfter = moment().subtract(dateAfterParts[1], dateAfterParts[2]).toDate();\n            }\n          }\n        }\n\n        const flatpickrInstance = $('.user-date-input')[0]._flatpickr;\n        flatpickrInstance.set('minDate', dateAfter ? dateAfter : null);\n      };\n\n      switch (type) {\n        case 'text':\n          $('.user-text-input').show();\n        break;\n        case 'date':\n          $('.user-date-input').show();\n        break;\n      }\n\n      $('#botHintText').text(data.hint || '');\n\n      $('.chat-body').append(\n        `<div class=\"message-container\">\n          <img src=\"/wp-content/themes/metatavu-wordpress/inc/assets/gfx/robot-head.png\" class=\"robot-avatar\" />\n          <div class=\"message message-received\">\n            <p class=\"message-content\">\n              ${data.response}\n            </p>\n          </div>\n        </div>`  \n      );\n\n      scrollChatBody();\n      updateBotStatus(sessionId, $('.chat-window').is(\":visible\") , $('.chat-container').get(0).outerHTML);\n    });\n  });\n  \n  $(document).ready(() => {\n    $('.bot-typing').hide();\n    $('.user-date-input').flatpickr({\n      \"locale\": \"fi\",\n      \"dateFormat\": \"d.m.Y\",\n      \"allowInput\": false\n    });\n    \n    if (useOldConversation()) {\n      appendChatContentFromLocalStorage();\n      checkChatOpenStatus();\n    } else {\n      $('.send-msg-btn').attr('disabled', 'disabled');\n      window.metamind.sendMessage('INIT', 'send_message');\n    }\n  });\n  \n  $(document).on('keydown', (event) => {\n    if (event.keyCode === 13) {\n      sendMessage();\n    }\n  });\n  \n})();"]}